---
title: "Hop Exchangeã®Stakeå®Ÿè£…èª¿æŸ»ãƒ¡ãƒ¢(StakingRewards.sol)"
emoji: "ðŸ‘¨â€ðŸŒ¾"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["solidity"]
published: true
---

https://app.hop.exchange/#/stake

# ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆä¾‹
https://polygonscan.com/address/0x2C2Ab81Cf235e86374468b387e241DF22459A265#code

## Compiler Version
- v0.5.16+commit.9c3226ce

## ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³
```solidity:StakingRewards
interface IERC20 {...}
interface IStakingRewards {
    // Views
    function lastTimeRewardApplicable() external view returns (uint256);
    function rewardPerToken() external view returns (uint256);
    function earned(address account) external view returns (uint256);
    function getRewardForDuration() external view returns (uint256);
    function totalSupply() external view returns (uint256);
    function balanceOf(address account) external view returns (uint256);

    // Mutative
    function stake(uint256 amount) external;
    function withdraw(uint256 amount) external;
    function getReward() external;
    function exit() external;
}
interface IUniswapV2ERC20 {...}

contract ERC20Detailed is IERC20 {...}
contract ReentrancyGuard {...}
contract RewardsDistributionRecipient {...}
contract StakingRewards is IStakingRewards, RewardsDistributionRecipient, ReentrancyGuard {...}

library Math {...}
library SafeMath {...}
library Address {...}
library SafeERC20  {...}
```

# ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã”ã¨ã®å‡¦ç†è©³ç´°
## LPãƒˆãƒ¼ã‚¯ãƒ³ã‚’é ã‘ã‚‹ (StakingRewards.stake)
```solidity
function stake(uint256 amount) external nonReentrant updateReward(msg.sender) {
    require(amount > 0, "Cannot stake 0");
    _totalSupply = _totalSupply.add(amount);
    _balances[msg.sender] = _balances[msg.sender].add(amount);
    stakingToken.safeTransferFrom(msg.sender, address(this), amount);
    emit Staked(msg.sender, amount);
}
```
1. updateRewardã«ã¦å¯¾è±¡è€…ã®ç²å¾—å ±é…¬ã‚’æ›´æ–°ã™ã‚‹(å¾Œè¿°)
1. ã‚¹ãƒ†ãƒ¼ã‚¯é¡ã‚’åŠ ç®—ã™ã‚‹
1. LPãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ¦ãƒ¼ã‚¶ã‹ã‚‰ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã«é€ã‚‹ã€‚ä¾‹ã®ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã§ã¯`stakingToken`ã¯[Hop USDC LP Token](https://polygonscan.com/address/0x9d373d22fd091d7f9a6649eb067557cc12fb1a0a)ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹


## ã‚¹ãƒ†ãƒ¼ã‚¯å ±é…¬ã‚’å–å¾—ã™ã‚‹ (StakingRewards.getReward)
```solidity
function getReward() public nonReentrant updateReward(msg.sender) {
    uint256 reward = rewards[msg.sender];
    if (reward > 0) {
        rewards[msg.sender] = 0;
        rewardsToken.safeTransfer(msg.sender, reward);
        emit RewardPaid(msg.sender, reward);
    }
}
```
1. updateRewardã«ã¦å¯¾è±¡è€…ã®ç²å¾—å ±é…¬ã‚’æ›´æ–°ã™ã‚‹(å¾Œè¿°)
1. ç²å¾—å ±é…¬ãŒå­˜åœ¨ã—ãŸã‚‰ãƒ¦ãƒ¼ã‚¶ã«ã™ã¹ã¦é€ã‚‹ã€‚ä¾‹ã®ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã§ã¯`rewardsToken`ã¯[WMATIC](https://polygonscan.com/address/0x0d500b1d8e8ef31e21c99d1db9a6444d3adf1270)ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹


## LPãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¸€éƒ¨å¼•ãå‡ºã™ (StakingRewards.withdraw)
```solidity
function withdraw(uint256 amount) public nonReentrant updateReward(msg.sender) {
    require(amount > 0, "Cannot withdraw 0");
    _totalSupply = _totalSupply.sub(amount);
    _balances[msg.sender] = _balances[msg.sender].sub(amount);
    stakingToken.safeTransfer(msg.sender, amount);
    emit Withdrawn(msg.sender, amount);
}
```
1. updateRewardã«ã¦å¯¾è±¡è€…ã®ç²å¾—å ±é…¬ã‚’æ›´æ–°ã™ã‚‹(å¾Œè¿°)
1. ã‚¹ãƒ†ãƒ¼ã‚¯é¡ã‚’æ¸›ç®—ã™ã‚‹
1. ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ã«é€ã‚‹


## LPãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã™ã¹ã¦å¼•ãå‡ºã™ (StakingRewards.exit)
```solidity
function exit() external {
    withdraw(_balances[msg.sender]);
    getReward();
}
```
1. å…¨é¡LPãƒˆãƒ¼ã‚¯ãƒ³ã‚’å¼•ãå‡ºã™(å‰è¿°ã®å†…å®¹)
1. ã‚¹ãƒ†ãƒ¼ã‚¯å ±é…¬ã‚’ç²å¾—ã™ã‚‹(å‰è¿°ã®å†…å®¹)


# ç²å¾—å ±é…¬é¡æ›´æ–°ã®ä»•çµ„ã¿(StakingRewards.updateReward)
:::details é–¢é€£ã‚³ãƒ¼ãƒ‰
```solidity
modifier updateReward(address account) {
    rewardPerTokenStored = rewardPerToken();
    lastUpdateTime = lastTimeRewardApplicable();
    if (account != address(0)) {
        rewards[account] = earned(account);
        userRewardPerTokenPaid[account] = rewardPerTokenStored;
    }
    _;
}

function rewardPerToken() public view returns (uint256) {
    if (_totalSupply == 0) {
        return rewardPerTokenStored;
    }
    return
        rewardPerTokenStored.add(
            lastTimeRewardApplicable().sub(lastUpdateTime).mul(rewardRate).mul(1e18).div(_totalSupply)
        );
}

function lastTimeRewardApplicable() public view returns (uint256) {
    return Math.min(block.timestamp, periodFinish);
}

function earned(address account) public view returns (uint256) {
    return _balances[account].mul(rewardPerToken().sub(userRewardPerTokenPaid[account])).div(1e18).add(rewards[account]);
}
```
:::

- å ±é…¬é¡ã¯ã€æ±ºã‚ã‚‰ã‚Œã¦ã„ã‚‹æ¯Žç§’ã®å ±é…¬é¡ã‚’ã‚¹ãƒ†ãƒ¼ã‚¯ã‚·ã‚§ã‚¢çŽ‡ã«å¿œã˜ã¦åˆ†é…ã•ã‚Œã‚‹
    - R = 1ç§’é–“ã®å ±é…¬
    - l(u,t) = ãƒ¦ãƒ¼ã‚¶uãŒæ™‚é–“tã«ã‚¹ãƒ†ãƒ¼ã‚¯ã—ã¦ã„ã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ã®é‡
    - L(t) = æ™‚é–“tã«ãŠã‘ã‚‹ã‚¹ãƒ†ãƒ¼ã‚¯ã•ã‚Œã¦ã„ã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ã®ç·é‡

$$
r(u, a, b) = \displaystyle\sum_{t=a}^b R \text{\(\frac {l(u,t)} {L(t)}\)}
$$

- ã‚¹ãƒžãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆä¸Šã§å‹•ãã‚ˆã†ã«åŠ¹çŽ‡çš„ãªå¼ã«å¤‰æ›ã—ãŸã‚‚ã®ãŒä»¥ä¸‹(è©³ç´°ã¯å‚è€ƒã«ã‚ã‚‹å‹•ç”»ã‚’å‚ç…§)

$$
Rk(
    \displaystyle\sum_{t=0}^b \text{\(\frac 1 {L(t)}\)} - 
    \displaystyle\sum_{t=0}^{a-1} \text{\(\frac 1 {L(t)}\)}
)
$$


## å…·ä½“ä¾‹
![](/images/9a6f6e33d6326c/1.png)
- ç§’é–“30ã®å ±é…¬ã‚’10ç§’é–“å¾—ã‚‰ã‚Œã‚‹ã¨ã™ã‚‹
    - reward: 300
    - rewardRate: 30
    - rewardsDuration: 10
### æ¯Žç§’è¨ˆç®—ã—ãŸå ´åˆ
|user|![](/images/9a6f6e33d6326c/shark.png)| | |![](/images/9a6f6e33d6326c/clownfish.png)| | |![](/images/9a6f6e33d6326c/fish.png)| | | |
|---|---|---|---|---|---|---|---|---|---|---|
||_balances|earned| |_balances|earned| |_balances|earned| |_totalSupply|
|t=1|0|0||0|0||0|0||0|
|t=2|100|30||0|0||0|0||100|
|t=3|100|60||0|0||0|0||100|
|t=4|100|75||100|15||0|0||200|
|t=5|100|85||100|25||100|10||300|
|t=6|100|95||100|35||100|20||300|
|t=7|100|110||0|35||100|35||200|
|t=8|100|125||0|35||100|50||200|
|t=9|500|150||0|35||100|55||600|
|t=10|500|175||0|35||100|60||600|
- t=1ã¯ã‚¹ãƒ†ãƒ¼ã‚­ãƒ³ã‚°ãŒãªã„ãŸã‚ãã®åˆ†ã‚’é™¤ã„ãŸåˆè¨ˆ270ã«ãªã‚‹

### ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆå®Ÿè¡Œã—ãŸå ´åˆ
- _totalSupplyã¯å‡¦ç†çµ‚äº†æ™‚ã®å€¤
- _totalSupplyä»¥å¤–ã¯updateRewardå†…ã§ã®å¤‰æ•°ä»£å…¥æ™‚ç‚¹ã®å€¤

|t|user|type|rewardPerTokenStored|rewards[account]|_totalSupply|
|---|---|---|---|---|---|
|0|||0|0|0|
|1|![](/images/9a6f6e33d6326c/shark.png)|stake|0|0|100|
|3|![](/images/9a6f6e33d6326c/clownfish.png)|stake|60*10^16|0|200|
|4|![](/images/9a6f6e33d6326c/fish.png)|stake|75*10^16|0|300|
|6|![](/images/9a6f6e33d6326c/clownfish.png)|exit|95*10^16|35|200|
|8|![](/images/9a6f6e33d6326c/shark.png)|stake|125*10^16|125|600|
|10|![](/images/9a6f6e33d6326c/shark.png)|exit|135*10^16|175|100|
|11|![](/images/9a6f6e33d6326c/fish.png)|exit|135*10^16|60|0|

- åˆè¨ˆç²å¾—å ±é…¬ã¯ä»¥ä¸‹ã®é€šã‚Šæ¯Žç§’è¨ˆç®—ã—ãŸå ´åˆã¨ä¸€è‡´
    |![](/images/9a6f6e33d6326c/shark.png)|![](/images/9a6f6e33d6326c/clownfish.png)|![](/images/9a6f6e33d6326c/fish.png)|
    |---|---|---|
    |175|35|60|


# å‚™è€ƒ
- [Synthetixã®ã‚¹ãƒ†ãƒ¼ã‚¯ã‚‚ã»ã¼åŒã˜ã‚³ãƒ¼ãƒ‰](https://github.com/Synthetixio/synthetix/blob/develop/contracts/StakingRewards.sol)(HopãŒSynthetixç­‰ã®ã‚³ãƒ”ãƒ¼ã®ã¯ãš)

- notifyRewardAmount

    :::details ã‚³ãƒ¼ãƒ‰
    ```solidity
    function notifyRewardAmount(uint256 reward) external onlyRewardsDistribution updateReward(address(0)) {
        if (block.timestamp >= periodFinish) {
            rewardRate = reward.div(rewardsDuration);
        } else {
            uint256 remaining = periodFinish.sub(block.timestamp);
            uint256 leftover = remaining.mul(rewardRate);
            rewardRate = reward.add(leftover).div(rewardsDuration);
        }

        // Ensure the provided reward amount is not more than the balance in the contract.
        // This keeps the reward rate in the right range, preventing overflows due to
        // very high values of rewardRate in the earned and rewardsPerToken functions;
        // Reward + leftover must be less than 2^256 / 10^18 to avoid overflow.
        uint balance = rewardsToken.balanceOf(address(this));
        require(rewardRate <= balance.div(rewardsDuration), "Provided reward too high");

        lastUpdateTime = block.timestamp;
        periodFinish = block.timestamp.add(rewardsDuration);
        emit RewardAdded(reward);
    }
    ```
    :::

    - `reward`ã‚’`rewardsDuration`ã§å‰²ã£ã¦`rewardRate`ã‚’è¨­å®šã™ã‚‹
        - æœªåˆ†é…ã®å ±é…¬ãŒã‚ã‚‹å ´åˆã¯ãã®å€¤ãŒ`reward`ã«åŠ ç®—ã•ã‚ŒãŸå€¤ã§`rewardRate`ãŒç®—å‡ºã•ã‚Œã‚‹
    - çµ‚äº†æ™‚åˆ»ã¯`block.timestamp` + `rewardsDuration`ã«æ›´æ–°ã•ã‚Œã‚‹

# å‚è€ƒ
https://github.com/hop-protocol/hop/blob/develop/packages/frontend/src/pages/Stake/StakeWidget.tsx
https://www.youtube.com/watch?v=6ZO5aYg1GI8

